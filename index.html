<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Call + Chat</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            background: #121212; 
            z-index: 10; 
        }
        .active { display: flex; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        h1 { margin-bottom: 20px; text-align: center; }
        input { padding: 15px; font-size: 18px; border-radius: 12px; border: 2px solid #333; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; background: #222; color: white; outline: none; }
        button { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* Jitsi */
        #meet { width: 100%; height: 100%; background: #000; }

        /* –°—Å—ã–ª–∫–∞ */
        #link-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border-radius: 20px;
            display: none; align-items: center; gap: 10px; z-index: 20; border: 1px solid #444;
        }
        .copy-btn { padding: 5px 15px; font-size: 14px; background: #28a745; }

        /* –ß–∞—Ç –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ */
        .cw-box, div[style*="position:fixed"] {
            z-index: 99999 !important; 
        }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>üîí –í—Ö–æ–¥</h1>
        <p style="color:#aaa; margin-bottom: 30px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google</p>
        <div id="g_id_onload"
             data-client_id="18644844173-gnpd78k83mvuju5soen3heestm3socj8.apps.googleusercontent.com"
             data-callback="onGoogleLogin"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="pill" data-logo_alignment="left"></div>
    </div>

    <div id="lobby-screen" class="screen">
        <h1>üëã –ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span></h1>
        <p>–ö—É–¥–∞ –∑–≤–æ–Ω–∏–º?</p>
        <input type="text" id="room-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" onkeypress="handleEnter(event)">
        <button onclick="createRoom()">üöÄ –°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="call-screen" class="screen" style="background: black;">
        <div id="link-bar">
            <span style="font-size: 14px;">üîó –°—Å—ã–ª–∫–∞:</span>
            <button class="copy-btn" onclick="copyLink()">Copy</button>
        </div>
        <div id="meet"></div>
    </div>

    <script>
        const SERVER = 'meet.ffmuc.net';
        let currentUser = null;
        let targetRoom = null; 

        // 1. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –º—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã —Ä–∞–Ω–µ–µ
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            targetRoom = urlParams.get('room');
            checkAutoLogin(); // <-- –í–æ—Ç —ç—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Ö–æ–¥
        };

        // –î–µ–∫–æ–¥–µ—Ä —Ç–æ–∫–µ–Ω–∞
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // 2. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ü–ï–†–í–û–ú –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Google
        function onGoogleLogin(response) {
            const idToken = response.credential;
            // –°–û–•–†–ê–ù–Ø–ï–ú –¢–û–ö–ï–ù, –ß–¢–û–ë–´ –ó–ê–ü–û–ú–ù–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            localStorage.setItem("google_id_token", idToken);
            
            const payload = parseJwt(idToken);
            handleAuthSuccess(payload);
        }

        // 3. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∞–≤—Ç–æ-–≤—Ö–æ–¥)
        function checkAutoLogin() {
            const token = localStorage.getItem("google_id_token");
            if (!token) return; // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞
            
            try {
                const payload = parseJwt(token);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
                if (payload.exp * 1000 > Date.now()) {
                    handleAuthSuccess(payload);
                } else {
                    localStorage.removeItem("google_id_token"); // –¢–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö
                }
            } catch (e) { 
                localStorage.removeItem("google_id_token"); 
            }
        }

        // 4. –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –£–°–ü–ï–®–ù–û–ì–û –í–•–û–î–ê
        function handleAuthSuccess(userPayload) {
            console.log("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:", userPayload.name);
            currentUser = { name: userPayload.name, email: userPayload.email, avatar: userPayload.picture };
            
            // --- –ü–ï–†–ï–î–ê–ï–ú –î–ê–ù–ù–´–ï –í –ß–ê–¢ (–§–∏–∫—Å –¥–ª—è –±–æ—Ç–∞) ---
            window.CHAT_USER = {
                id: userPayload.email,
                name: userPayload.name
            };
            // ---------------------------------------------

            // –£–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            document.getElementById('login-screen').classList.remove('active');
            
            if (targetRoom) { 
                startJitsi(targetRoom); 
            } else { 
                document.getElementById('user-name').innerText = currentUser.name.split(' ')[0];
                document.getElementById('lobby-screen').classList.add('active'); 
            }
        }

        function handleEnter(e) { if (e.key === "Enter") createRoom(); }

        function createRoom() {
            const inputVal = document.getElementById('room-input').value.trim();
            if (!inputVal) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
            const finalRoomName = 'MyCall_' + inputVal; 
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + finalRoomName;
            window.history.pushState({path: newUrl}, '', newUrl);
            startJitsi(finalRoomName);
        }

        function startJitsi(roomName) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('link-bar').style.display = 'flex';

            const api = new JitsiMeetExternalAPI(SERVER, {
                roomName: roomName, width: '100%', height: '100%', parentNode: document.querySelector('#meet'),
                lang: 'ru', userInfo: { displayName: currentUser.name, email: currentUser.email },
                configOverwrite: { startWithAudioMuted: false, prejoinPageEnabled: false }
            });
            api.addEventListeners({
                videoConferenceLeft: function () { window.location.href = window.location.pathname; }
            });
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
        }
    </script>

    <script 
        src="https://friend-calling-bot.unclejoerus.workers.dev/chat.js" 
        data-room="2fbfbr1">
    </script>

</body>
</html>
