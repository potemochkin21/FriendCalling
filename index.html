<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Call</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column; align-items: center; justify-content: center; 
            background: #121212; z-index: 10;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
        .active { display: flex; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        h1 { margin-bottom: 20px; text-align: center; }
        input { padding: 15px; font-size: 18px; border-radius: 12px; border: 2px solid #333; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; background: #222; color: white; outline: none; }
        button { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Jitsi */
        #meet { width: 100%; height: 100%; background: #000; }

        /* –ü–ª–∞—à–∫–∞ —Å —Å—Å—ã–ª–∫–æ–π (–ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ) */
        #link-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border-radius: 20px;
            display: none; align-items: center; gap: 10px; z-index: 20; border: 1px solid #444;
        }
        .copy-btn { padding: 5px 15px; font-size: 14px; background: #28a745; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>üîí –í—Ö–æ–¥</h1>
        <p style="color:#aaa; margin-bottom: 30px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
        
        <div id="g_id_onload"
             data-client_id="18644844173-gnpd78k83mvuju5soen3heestm3socj8.apps.googleusercontent.com"
             data-callback="onGoogleLogin"
             data-auto_prompt="false">
        </div>

        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="pill"
             data-logo_alignment="left">
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <h1>üëã –ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span></h1>
        <p>–ö—É–¥–∞ –∑–≤–æ–Ω–∏–º?</p>
        <input type="text" id="room-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" onkeypress="handleEnter(event)">
        <button onclick="createRoom()">üöÄ –°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="call-screen" class="screen" style="background: black;">
        <div id="link-bar">
            <span style="font-size: 14px;">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É:</span>
            <button class="copy-btn" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="meet"></div>
    </div>

    <script>
        const SERVER = 'meet.ffmuc.net';
        let currentUser = null;
        let targetRoom = null; 

        // --- 1. –ü–†–û–í–ï–†–Ø–ï–ú –°–°–´–õ–ö–£ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            targetRoom = urlParams.get('room');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª)
            checkAutoLogin();

            if (targetRoom) {
                console.log("–¶–µ–ª–µ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞:", targetRoom);
            }
        };

        // --- 2. –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò GOOGLE ---
        
        // –§—É–Ω–∫—Ü–∏—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JWT (—á—Ç–æ–±—ã —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –Ω–µ –ª–æ–º–∞–ª–∏—Å—å)
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // –ö–æ–ª–±—ç–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç Google –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
        function onGoogleLogin(response) {
            const idToken = response.credential;
            localStorage.setItem("google_id_token", idToken); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
            
            const payload = parseJwt(idToken);
            handleAuthSuccess(payload);
        }

        // –ê–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function checkAutoLogin() {
            const token = localStorage.getItem("google_id_token");
            if (!token) return;

            try {
                const payload = parseJwt(token);
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
                if (payload.exp * 1000 > Date.now()) {
                    handleAuthSuccess(payload);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–≤—Ö–æ–¥–∞:", e);
                localStorage.removeItem("google_id_token");
            }
        }

        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—Ö–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é)
        function handleAuthSuccess(userPayload) {
            console.log("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:", userPayload);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —é–∑–µ—Ä–∞. Google –æ—Ç–¥–∞–µ—Ç: name, given_name, family_name, email, picture
            currentUser = {
                name: userPayload.name,        // –ü–æ–ª–Ω–æ–µ –∏–º—è
                email: userPayload.email,
                avatar: userPayload.picture
            };

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            document.getElementById('login-screen').classList.remove('active');

            // –õ–û–ì–ò–ö–ê –†–ê–ó–í–ò–õ–ö–ò:
            if (targetRoom) {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ -> –°—Ä–∞–∑—É –≤ –∑–≤–æ–Ω–æ–∫
                startJitsi(targetRoom);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ -> –í –ª–æ–±–±–∏
                document.getElementById('user-name').innerText = currentUser.name.split(' ')[0]; // –¢–æ–ª—å–∫–æ –∏–º—è
                document.getElementById('lobby-screen').classList.add('active');
            }
        }

        // --- 3. –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ù–ê–¢–´ ---
        function handleEnter(e) { if (e.key === "Enter") createRoom(); }

        function createRoom() {
            const inputVal = document.getElementById('room-input').value.trim();
            if (!inputVal) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            const finalRoomName = 'MyCall_' + inputVal; 

            // –û–±–Ω–æ–≤–ª—è–µ–º URL
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + finalRoomName;
            window.history.pushState({path: newUrl}, '', newUrl);

            startJitsi(finalRoomName);
        }

        // --- 4. –ó–ê–ü–£–°–ö JITSI ---
        function startJitsi(roomName) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('link-bar').style.display = 'flex';

            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet'),
                lang: 'ru',
                userInfo: {
                    displayName: currentUser.name, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∏–∑ Google
                    email: currentUser.email       // –î–ª—è Gravatar –∞–≤–∞—Ç–∞—Ä–æ–∫ –≤ Jitsi
                },
                configOverwrite: {
                    startWithAudioMuted: false,
                    prejoinPageEnabled: false 
                }
            };

            const api = new JitsiMeetExternalAPI(SERVER, options);
            
            api.addEventListeners({
                videoConferenceLeft: function () {
                    // –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∑–≤–æ–Ω–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º URL –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
                    window.location.href = window.location.pathname; 
                }
            });
        }

        // --- 5. –ö–ù–û–ü–ö–ê "–°–ö–û–ü–ò–†–û–í–ê–¢–¨" ---
        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –µ—ë –¥—Ä—É–≥—É.");
            });
        }
    </script>
       <script src="https://friend-calling-bot.unclejoerus.workers.dev/chat.js" data-room="2fbfbr1"></script>
    
    <script>
       // –ö–æ–≥–¥–∞ Google –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–¥–∞–µ–º –∏–º—è –≤ –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞
       function onGoogleLogin(response) {
           const idToken = response.credential;
           const payload = parseJwt(idToken);
           handleAuthSuccess(payload); // –í–∞—à–∞ —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è
           
           // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ—á–∫—É:
           window.CHAT_USER_NAME = payload.name; 
       }
    </script>
</body>
</html>
