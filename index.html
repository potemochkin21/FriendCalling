<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Call</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column; align-items: center; justify-content: center; 
            background: #121212; z-index: 10;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
        .active { display: flex; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        h1 { margin-bottom: 20px; text-align: center; }
        input { padding: 15px; font-size: 18px; border-radius: 12px; border: 2px solid #333; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; background: #222; color: white; outline: none; }
        button { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Jitsi */
        #meet { width: 100%; height: 100%; background: #000; }

        /* –ü–ª–∞—à–∫–∞ —Å —Å—Å—ã–ª–∫–æ–π (–ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ) */
        #link-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border-radius: 20px;
            display: none; align-items: center; gap: 10px; z-index: 20; border: 1px solid #444;
        }
        .copy-btn { padding: 5px 15px; font-size: 14px; background: #28a745; }
    </style>
</head>
<body>
    <div id="g_id_onload"
     data-client_id="18644844173-gnpd78k83mvuju5soen3heestm3socj8.apps.googleusercontent.com"
     data-callback="onGoogleLogin"
     data-auto_prompt="false">
</div>

<div class="g_id_signin"
     data-type="standard"
     data-size="large">
</div>


    <div id="login-screen" class="screen active">
        <h1>üîíClosed</h1>
        <p style="color:#aaa; margin-bottom: 30px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É</p>
        
        <script async src="https://telegram.org/js/telegram-widget.js?22" 
                data-telegram-login="FriendCalling_bot" 
                data-size="large" 
                data-radius="10" 
                data-onauth="onTelegramAuth(user)" 
                data-request-access="write"></script>
    </div>

    <div id="lobby-screen" class="screen">
        <h1>üëã –ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span></h1>
        <p>–ö—É–¥–∞ –∑–≤–æ–Ω–∏–º?</p>
        <input type="text" id="room-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" onkeypress="handleEnter(event)">
        <button onclick="createRoom()">üöÄ–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="call-screen" class="screen" style="background: black;">
        <div id="link-bar">
            <span style="font-size: 14px;">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É:</span>
            <button class="copy-btn" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="meet"></div>
    </div>

    <script>
        const SERVER = 'meet.ffmuc.net';
        let currentUser = null;
        let targetRoom = null; // –ö–æ–º–Ω–∞—Ç–∞, –∫—É–¥–∞ —Ö–æ—á–µ—Ç –ø–æ–ø–∞—Å—Ç—å —á–µ–ª–æ–≤–µ–∫

        // --- 1. –ü–†–û–í–ï–†–Ø–ï–ú –°–°–´–õ–ö–£ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            
            if (roomFromUrl) {
                targetRoom = roomFromUrl;
                console.log("–ß–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ –≤ –∫–æ–º–Ω–∞—Ç—É:", targetRoom);
            }
        };

        // --- 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –¢–ì) ---
        function onTelegramAuth(user) {
            console.log("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:", user);
            currentUser = user;

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            document.getElementById('login-screen').classList.remove('active');

            // –õ–û–ì–ò–ö–ê –†–ê–ó–í–ò–õ–ö–ò:
            if (targetRoom) {
                // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ -> –°—Ä–∞–∑—É –≤ –∑–≤–æ–Ω–æ–∫
                startJitsi(targetRoom);
            } else {
                // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç -> –î–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                document.getElementById('user-name').innerText = user.first_name;
                document.getElementById('lobby-screen').classList.add('active');
            }
        }

        // --- 3. –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ù–ê–¢–´ (–•–û–°–¢) ---
        function handleEnter(e) { if (e.key === "Enter") createRoom(); }

        function createRoom() {
            const inputVal = document.getElementById('room-input').value.trim();
            if (!inputVal) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å—Å—è —Å —á—É–∂–∏–º–∏
            // –ù–æ –¥–µ–ª–∞–µ–º –µ–≥–æ —á–∏—Ç–∞–µ–º—ã–º, —á—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ –∫—Ä–∞—Å–∏–≤–æ–π
            const finalRoomName = 'MyCall_' + inputVal; 

            // –û–ë–ù–û–í–õ–Ø–ï–ú –°–°–´–õ–ö–£ –í –ë–†–ê–£–ó–ï–†–ï (–ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + finalRoomName;
            window.history.pushState({path: newUrl}, '', newUrl);

            startJitsi(finalRoomName);
        }

        // --- 4. –ó–ê–ü–£–°–ö JITSI ---
        function startJitsi(roomName) {
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–≤–æ–Ω–æ–∫
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('call-screen').classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('link-bar').style.display = 'flex';

            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet'),
                lang: 'ru',
                userInfo: {
                    displayName: currentUser.first_name + " " + (currentUser.last_name || "")
                },
                configOverwrite: {
                    startWithAudioMuted: false,
                    prejoinPageEnabled: false 
                }
            };

            const api = new JitsiMeetExternalAPI(SERVER, options);
            
            api.addEventListeners({
                videoConferenceLeft: function () {
                    window.location.href = window.location.pathname; // –ü–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                }
            });
        }

        // --- 5. –ö–ù–û–ü–ö–ê "–°–ö–û–ü–ò–†–û–í–ê–¢–¨" ---
        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –µ—ë –¥—Ä—É–≥—É.");
            });
        }
    </script>
</body>
    <script>
function onGoogleLogin(response) {
  const idToken = response.credential;

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
  localStorage.setItem("google_id_token", idToken);

  const payload = JSON.parse(atob(idToken.split(".")[1]));

  console.log("Logged in as:", payload);

  renderUser(payload);
}

function renderUser(user) {
  document.body.insertAdjacentHTML("beforeend", `
    <div id="user">
      üë§ ${user.name}<br>
      üìß ${user.email}
    </div>
  `);
}

// –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
(function(){
  const token = localStorage.getItem("google_id_token");
  if (!token) return;

  const payload = JSON.parse(atob(token.split(".")[1]));
  if (payload.exp * 1000 < Date.now()) return;

  renderUser(payload);
})();
</script>

</html>
