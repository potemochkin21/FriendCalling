<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>friend-calling</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    
    <style>
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body { margin: 0; font-family: 'Arial', sans-serif; background-color: #121212; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* –°—Ç–∏–ª—å "–ü—Ä–∏—Ö–æ–∂–µ–π" */
        #lobby { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; transition: opacity 0.5s; }
        h1 { margin-bottom: 20px; font-size: 24px; }
        input { padding: 15px; font-size: 18px; border-radius: 12px; border: 2px solid #333; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; background: #222; color: white; outline: none; }
        button.start-btn { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; background: #007bff; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.4); transition: 0.2s; }
        button.start-btn:active { transform: scale(0.95); }

        /* –ú–µ—Å—Ç–æ –¥–ª—è –≤–∏–¥–µ–æ */
        #meet { flex: 1; width: 100%; display: none; }

        /* --- –û–ö–ù–û –° –û–®–ò–ë–ö–û–ô (–°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) --- */
        #error-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .error-box {
            background: #2c0b0e; border: 2px solid #ff4444; padding: 20px; border-radius: 15px;
            width: 90%; max-width: 500px; text-align: left; box-shadow: 0 0 20px rgba(255,0,0,0.3);
        }
        .error-title { color: #ff4444; font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .error-text { 
            background: #000; color: #0f0; font-family: monospace; padding: 10px; 
            border-radius: 5px; overflow-x: auto; font-size: 12px; margin-bottom: 15px; white-space: pre-wrap; 
        }
        .copy-btn { background: #444; color: white; border: 1px solid #666; padding: 8px 15px; cursor: pointer; border-radius: 5px; margin-right: 10px; }
        .close-btn { background: transparent; color: #aaa; border: none; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div id="error-modal">
        <div class="error-box">
            <div class="error-title">üö® –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</div>
            <p style="font-size: 14px; color: #ccc;">–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É:</p>
            <div id="error-content" class="error-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div style="display: flex; align-items: center;">
                <button class="copy-btn" onclick="copyError()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É</button>
                <button class="close-btn" onclick="document.getElementById('error-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="lobby">
        <h1>üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h1>
        <p style="color: #888; font-size: 14px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</p>
        <input type="text" id="room-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: tusovka" onkeypress="handleEnter(event)">
        <button class="start-btn" onclick="enterRoom()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <div id="meet"></div>

    <script>
        // --- –°–ò–°–¢–ï–ú–ê –û–¢–õ–û–í–ê –û–®–ò–ë–û–ö ---
        function showError(title, details) {
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-content');
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
            const fullMessage = `TYPE: ${title}\nTIME: ${new Date().toLocaleTimeString()}\nDETAILS: ${details}\nURL: ${window.location.href}`;
            content.innerText = fullMessage;
            modal.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
        }

        // –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ JS
        window.onerror = function(message, source, lineno, colno, error) {
            showError('Javascript Error', `${message}\nLine: ${lineno}\nSource: ${source}`);
            return true; 
        };

        // –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ "–û–±–µ—â–∞–Ω–∏–π" (–∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª)
        window.onunhandledrejection = function(event) {
            showError('Promise Rejection', event.reason || event.message || "Unknown Network Error");
        };
        
        function copyError() {
            const text = document.getElementById('error-content').innerText;
            navigator.clipboard.writeText(text).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
        }
        // -----------------------------


        // --- –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê ---
        // 'meet.ffmuc.net' - –ú—é–Ω—Ö–µ–Ω (–°—Ç–∞–±–∏–ª—å–Ω—ã–π, –±–ª–∏–∑–∫–æ –∫ –†–§, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
        // –ï—Å–ª–∏ –æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ 'meet.guifi.net'
        const SERVER_DOMAIN = 'meet.ffmuc.net'; 


        window.onload = () => {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomFromUrl = urlParams.get('room');
                if (roomFromUrl) startCall(roomFromUrl);
            } catch (e) {
                showError('Init Error', e.message);
            }
        }

        function handleEnter(e) { if (e.key === "Enter") enterRoom(); }

        function enterRoom() {
            const inputVal = document.getElementById('room-input').value.trim();
            if (!inputVal) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã!");
            
            // –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            const fullRoomName = 'MyCall_' + inputVal; 
            
            // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + fullRoomName;
            window.history.pushState({path: newUrl}, '', newUrl);

            startCall(fullRoomName);
        }

        function startCall(roomName) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ —Å–∫—Ä–∏–ø—Ç Jitsi –≤–æ–æ–±—â–µ
            if (typeof JitsiMeetExternalAPI === 'undefined') {
                showError('Library Error', '–°–∫—Ä–∏–ø—Ç Jitsi –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ VPN.');
                return;
            }

            document.getElementById('lobby').style.display = 'none';
            document.getElementById('meet').style.display = 'block';

            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet'),
                lang: 'ru',
                configOverwrite: {
                    startWithAudioMuted: false,
                    prejoinPageEnabled: false,
                    // –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ P2P, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –≤ –†–§
                    p2p: { enabled: true }
                }
            };

            try {
                const api = new JitsiMeetExternalAPI(SERVER_DOMAIN, options);
                
                api.addEventListeners({
                    videoConferenceLeft: function () { window.location.reload(); },
                    // –ï—Å–ª–∏ —Å–∞–º Jitsi –≤—ã–¥–∞—Å—Ç —Ñ–∞—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
                    fatalError: function(e) { showError('Jitsi Fatal', JSON.stringify(e)); }
                });
            } catch (e) {
                showError('API Start Error', e.message);
            }
        }
    </script>
</body>
</html>
