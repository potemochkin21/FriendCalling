<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Call + Chat</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #000; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            background: #121212; 
            z-index: 10; /* –í–∏–¥–µ–æ—Å–ª–æ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ 10 */
        }
        .active { display: flex; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        h1 { margin-bottom: 20px; text-align: center; }
        input { padding: 15px; font-size: 18px; border-radius: 12px; border: 2px solid #333; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; background: #222; color: white; outline: none; }
        button { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* Jitsi */
        #meet { width: 100%; height: 100%; background: #000; }

        /* –°—Å—ã–ª–∫–∞ */
        #link-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border-radius: 20px;
            display: none; align-items: center; gap: 10px; z-index: 20; border: 1px solid #444;
        }
        .copy-btn { padding: 5px 15px; font-size: 14px; background: #28a745; }

        /* --- –í–ê–ñ–ù–û: –°–¢–ò–õ–ò –î–õ–Ø –ß–ê–¢–ê, –ß–¢–û–ë–´ –û–ù –ë–´–õ –ü–û–í–ï–†–• –í–ò–î–ï–û --- */
        /* –≠—Ç–∏ —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –∫–Ω–æ–ø–∫–µ —á–∞—Ç–∞, –∫–æ—Ç–æ—Ä—É—é —Å–æ–∑–¥–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç */
        .cw-box, div[style*="position:fixed"] {
            z-index: 99999 !important; /* –°–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π */
        }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>üîí –í—Ö–æ–¥</h1>
        <p style="color:#aaa; margin-bottom: 30px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google</p>
        <div id="g_id_onload"
             data-client_id="18644844173-gnpd78k83mvuju5soen3heestm3socj8.apps.googleusercontent.com"
             data-callback="onGoogleLogin"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="pill" data-logo_alignment="left"></div>
    </div>

    <div id="lobby-screen" class="screen">
        <h1>üëã –ü—Ä–∏–≤–µ—Ç, <span id="user-name">...</span></h1>
        <p>–ö—É–¥–∞ –∑–≤–æ–Ω–∏–º?</p>
        <input type="text" id="room-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" onkeypress="handleEnter(event)">
        <button onclick="createRoom()">üöÄ –°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="call-screen" class="screen" style="background: black;">
        <div id="link-bar">
            <span style="font-size: 14px;">üîó –°—Å—ã–ª–∫–∞:</span>
            <button class="copy-btn" onclick="copyLink()">Copy</button>
        </div>
        <div id="meet"></div>
    </div>

    <script>
        const SERVER = 'meet.ffmuc.net';
        let currentUser = null;
        let targetRoom = null; 

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            targetRoom = urlParams.get('room');
            checkAutoLogin();
        };

        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function onGoogleLogin(response) {
            const idToken = response.credential;
            localStorage.setItem("google_id_token", idToken);
            const payload = parseJwt(idToken);
            handleAuthSuccess(payload);
        }

        function checkAutoLogin() {
            const token = localStorage.getItem("google_id_token");
            if (!token) return;
            try {
                const payload = parseJwt(token);
                if (payload.exp * 1000 > Date.now()) handleAuthSuccess(payload);
            } catch (e) { localStorage.removeItem("google_id_token"); }
        }

        function handleAuthSuccess(userPayload) {
            currentUser = { name: userPayload.name, email: userPayload.email, avatar: userPayload.picture };
            document.getElementById('login-screen').classList.remove('active');
            
            window.CHAT_USER_NAME = currentUser.name;
            
            // --- –ü–ï–†–ï–î–ê–ï–ú –ò–ú–Ø –í –ß–ê–¢ ---
            if (window.sendChat) {
                // –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥–∞—Ç—å –∏–º—è, 
                // –Ω–æ –≤ –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏ KV –≤–æ—Ä–∫–µ—Ä–∞ –∏–º—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.
                // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º.
            }

            if (targetRoom) { startJitsi(targetRoom); } 
            else { 
                document.getElementById('user-name').innerText = currentUser.name.split(' ')[0];
                document.getElementById('lobby-screen').classList.add('active'); 
            }
        }

        function handleEnter(e) { if (e.key === "Enter") createRoom(); }

        function createRoom() {
            const inputVal = document.getElementById('room-input').value.trim();
            if (!inputVal) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
            const finalRoomName = 'MyCall_' + inputVal; 
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + finalRoomName;
            window.history.pushState({path: newUrl}, '', newUrl);
            startJitsi(finalRoomName);
        }

        function startJitsi(roomName) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('link-bar').style.display = 'flex';

            const api = new JitsiMeetExternalAPI(SERVER, {
                roomName: roomName, width: '100%', height: '100%', parentNode: document.querySelector('#meet'),
                lang: 'ru', userInfo: { displayName: currentUser.name, email: currentUser.email },
                configOverwrite: { startWithAudioMuted: false, prejoinPageEnabled: false }
            });
            api.addEventListeners({
                videoConferenceLeft: function () { window.location.href = window.location.pathname; }
            });
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
        }
    </script>

    <script 
        src="https://friend-calling-bot.unclejoerus.workers.dev/chat.js" 
        data-room="2fbfbr1">
    </script>

</body>
</html>
